---
phase: 12-lead-capture
plan: 01
type: execute
---

<objective>
Create Leads collection for capturing form submissions with full experiment attribution.

Purpose: Enable lead tracking tied to specific experiments, variants, and visitors for A/B test conversion analysis.
Output: Leads collection with experiment/variant/visitor attribution, form data capture, and integration tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-experiment-collection/10-01-SUMMARY.md
@.planning/phases/11-visitor-assignment/11-01-SUMMARY.md
@dev/collections/Experiments.ts
@dev/collections/PageVariants.ts
@dev/utils/visitorId.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Leads collection with attribution fields</name>
  <files>dev/collections/Leads.ts, dev/payload.config.ts</files>
  <action>
Create Leads collection following Experiments.ts patterns:

**Fields:**
- `email` (text, required) - Lead email address, use email validation
- `name` (text, optional) - Lead name
- `experiment` (relationship to experiments, optional) - Which experiment this lead was captured from
- `variant` (relationship to page-variants, optional) - Which variant the visitor saw
- `visitorId` (text, optional) - The visitor ID from cookie at time of submission
- `page` (relationship to pages, optional) - Which page the form was on
- `formData` (json, optional) - Arbitrary additional form fields as JSON object
- `source` (text, optional) - Where the lead came from (e.g., "hero-cta", "footer-form")
- `convertedAt` (date) - Auto-set to current date on creation

**Collection config:**
- slug: 'leads'
- admin.useAsTitle: 'email'
- timestamps: true (default)

**Hook (beforeChange):**
- On create: Set convertedAt to current date if not already set

Register collection in payload.config.ts.
  </action>
  <verify>pnpm generate:types succeeds, no TypeScript errors</verify>
  <done>Leads collection exists with all attribution fields, types generated</done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests for Leads collection</name>
  <files>dev/int.spec.ts</files>
  <action>
Add new describe block 'Leads collection' with tests:

1. **can create lead with email only** - Minimal lead creation, verify convertedAt auto-set
2. **can create lead with full attribution** - Create experiment, variant, page, then lead with all relationships
3. **can create lead with custom formData** - Verify JSON field stores arbitrary data
4. **lead captures visitorId** - Verify visitorId field stores correctly

Pattern: Follow existing Experiments collection tests structure. Use beforeAll to create test fixtures (page, variant, experiment) that subsequent tests can reference.
  </action>
  <verify>pnpm test:int passes with new tests</verify>
  <done>4 new Leads tests passing, all existing tests still pass</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `pnpm generate:types` succeeds
- [ ] `pnpm lint` passes
- [ ] `pnpm test:int` passes (all tests including new Leads tests)
- [ ] Leads collection visible in admin at /admin/collections/leads
</verification>

<success_criteria>

- Leads collection created with all attribution fields
- All 4 integration tests passing
- Types generated correctly
- No lint errors
- Phase 12 complete
</success_criteria>

<output>
After completion, create `.planning/phases/12-lead-capture/12-01-SUMMARY.md`
</output>
