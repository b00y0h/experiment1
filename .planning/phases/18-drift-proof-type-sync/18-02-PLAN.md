---
phase: 18-drift-proof-type-sync
plan: 02
type: execute
---

<objective>
Add CI gates and integration tests for registry/rendering coverage.

Purpose: Ensure registry.json artifact stays in sync with code, and all blocks have rendering coverage.
Output: CI-ready scripts that catch drift between registry code, JSON artifact, and render components.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-drift-proof-type-sync/18-01-SUMMARY.md
@dev/blocks/registry.ts
@dev/blocks/generate.ts
@dev/block-registry.json
@dev/render/renderBlock.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create registry sync check script</name>
  <files>dev/blocks/check-registry.ts, package.json</files>
  <action>
    Create a script that:
    1. Generates fresh registry JSON in memory
    2. Compares against dev/block-registry.json on disk
    3. Exits with error code if they differ

    Script at dev/blocks/check-registry.ts:
    ```typescript
    import { readFileSync } from 'fs'
    import { generateRegistrySchema } from './schema.js'

    const diskRegistry = JSON.parse(readFileSync('dev/block-registry.json', 'utf-8'))
    const freshRegistry = generateRegistrySchema()

    // Compare blocks (ignore generatedAt timestamp)
    const diskBlocks = JSON.stringify(diskRegistry.blocks)
    const freshBlocks = JSON.stringify(freshRegistry.blocks)

    if (diskBlocks !== freshBlocks) {
      console.error('Registry drift detected!')
      console.error('Run: pnpm generate:registry')
      process.exit(1)
    }

    console.log('Registry sync: OK')
    ```

    Add to package.json scripts:
    ```
    "check:registry": "tsx dev/blocks/check-registry.ts"
    ```

    Why: CI can run `pnpm check:registry` to fail builds where someone updated registry.ts but forgot to regenerate the JSON.
  </action>
  <verify>pnpm check:registry exits 0; modify registry.ts, verify check:registry exits 1</verify>
  <done>check:registry script detects registry code/JSON drift</done>
</task>

<task type="auto">
  <name>Task 2: Add rendering coverage test</name>
  <files>dev/int.spec.ts</files>
  <action>
    Add comprehensive test that verifies:
    1. Every block in registry.json has a corresponding case in renderBlock
    2. Every block type renders without throwing
    3. Every placeholder component has proper displayName

    Add to renderBlock test group:
    ```typescript
    test('100% rendering coverage: all registry blocks render successfully', () => {
      // Load registry JSON (source of truth for deployed blocks)
      const registryJson = require('./block-registry.json')

      for (const blockDef of registryJson.blocks) {
        // Create minimal valid block for each type
        const testBlock = createMinimalBlock(blockDef.slug)

        // Verify it renders without throwing
        expect(() => renderBlockSafe(testBlock)).not.toThrow()

        // Verify we get a valid element
        const result = renderBlockSafe(testBlock)
        expect(isValidElement(result)).toBe(true)
      }
    })
    ```

    Add helper function:
    ```typescript
    function createMinimalBlock(slug: string): { blockType: string; [key: string]: unknown } {
      // Return minimal valid data for each block type
      switch (slug) {
        case 'heroBlock':
          return { blockType: 'heroBlock', headline: 'Test' }
        case 'accordionBlock':
          return { blockType: 'accordionBlock', items: [] }
        case 'contentBlock':
          return { blockType: 'contentBlock' }
        case 'faqBlock':
          return { blockType: 'faqBlock', items: [] }
        case 'statsBlock':
          return { blockType: 'statsBlock', items: [] }
        case 'footerBlock':
          return { blockType: 'footerBlock' }
        case 'reusableBlockRef':
          return { blockType: 'reusableBlockRef', block: 'test-id' }
        default:
          return { blockType: slug }
      }
    }
    ```

    Why: This catches the case where registry has a block but renderBlock doesn't handle it properly.
  </action>
  <verify>pnpm test:int passes; remove a case from renderBlock, verify test fails</verify>
  <done>Test verifies 100% rendering coverage from registry.json</done>
</task>

<task type="auto">
  <name>Task 3: Add CI check script combining all validations</name>
  <files>package.json</files>
  <action>
    Add a combined CI check script that runs all drift-proof validations:

    Add to package.json scripts:
    ```
    "check:sync": "pnpm check:registry && pnpm generate:types && tsc --noEmit -p dev/tsconfig.json"
    ```

    This script:
    1. Verifies registry.json matches registry.ts
    2. Regenerates Payload types (in case schema changed)
    3. Runs TypeScript compiler to catch type drift

    Why: Single command for CI to run before tests that catches all drift scenarios.
  </action>
  <verify>pnpm check:sync exits 0</verify>
  <done>check:sync script combines all drift-proof validations for CI</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm check:registry` exits 0
- [ ] `pnpm check:sync` exits 0
- [ ] `pnpm test:int` passes with new coverage test
- [ ] Manually verify: modifying registry.ts without regenerating JSON causes check:registry to fail
</verification>

<success_criteria>

- check:registry script detects code/JSON drift
- Test verifies 100% rendering coverage
- check:sync combines all validations for CI
- Phase 18 complete, ready for Phase 19
</success_criteria>

<output>
After completion, create `.planning/phases/18-drift-proof-type-sync/18-02-SUMMARY.md`
</output>
