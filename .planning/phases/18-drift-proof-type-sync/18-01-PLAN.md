---
phase: 18-drift-proof-type-sync
plan: 01
type: execute
---

<objective>
Enforce compile-time contract between block registry and render components.

Purpose: Make "CMS added new block but frontend didn't add renderer case" fail at TypeScript compilation, not at runtime.
Output: Type-safe contract where adding a block to registry without updating renderBlock() causes build failure.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-block-registry/16-01-SUMMARY.md
@.planning/phases/17-frontend-renderer-mapping/17-01-SUMMARY.md
@dev/blocks/registry.ts
@dev/render/renderBlock.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Export BlockType union from registry</name>
  <files>dev/blocks/registry.ts, dev/blocks/index.ts</files>
  <action>
    Create a BlockTypeSlug type that is derived from the blockRegistry keys, ensuring the registry is the single source of truth for block type names.

    1. Add to registry.ts:
       ```
       export type BlockTypeSlug = keyof typeof blockRegistry
       ```

    2. Export from blocks/index.ts barrel

    This makes blockRegistry.keys be the canonical list of block types.
  </action>
  <verify>pnpm generate:types && tsc --noEmit passes</verify>
  <done>BlockTypeSlug exported from dev/blocks/ and usable in other modules</done>
</task>

<task type="auto">
  <name>Task 2: Constrain renderBlock to registry types</name>
  <files>dev/render/renderBlock.tsx</files>
  <action>
    Update renderBlock.tsx to import BlockTypeSlug from registry and add a compile-time assertion that the switch statement covers all registry block types.

    1. Import BlockTypeSlug from '../blocks'

    2. Add a type-level assertion that BlockType (derived from Page types) equals BlockTypeSlug:
       ```typescript
       // Compile-time assertion: Page block types must match registry
       // If this fails, registry and Page schema are out of sync
       type AssertTypesMatch = BlockType extends BlockTypeSlug ? (BlockTypeSlug extends BlockType ? true : never) : never
       const _typeCheck: AssertTypesMatch = true
       ```

    3. The existing exhaustive switch already uses `never` for unhandled cases - this ensures TypeScript enforces coverage.

    Why: If someone adds 'newBlock' to registry but Page schema doesn't include it (or vice versa), TypeScript fails immediately.
  </action>
  <verify>pnpm generate:types && tsc --noEmit passes; Add a fake block to registry and verify tsc fails</verify>
  <done>TypeScript compilation fails if registry and Page block types diverge</done>
</task>

<task type="auto">
  <name>Task 3: Add sync verification test</name>
  <files>dev/int.spec.ts</files>
  <action>
    Add a test that verifies the registry block slugs exactly match what Payload generates in Page types.

    Add to renderBlock test group:
    ```typescript
    test('registry slugs match Page block types', () => {
      // Get slugs from registry
      const registrySlugs = getBlockSlugs().sort()

      // Get slugs from a sample page structure (what Payload types allow)
      // This is a runtime verification of the compile-time contract
      const pageBlockTypes: BlockType[] = [
        'accordionBlock', 'contentBlock', 'faqBlock', 'footerBlock',
        'heroBlock', 'reusableBlockRef', 'statsBlock'
      ]
      const payloadSlugs = pageBlockTypes.sort()

      expect(registrySlugs).toEqual(payloadSlugs)
    })
    ```

    This is a belt-and-suspenders check - the type assertion catches at compile time, this catches if test data drifts.
  </action>
  <verify>pnpm test:int passes with new test</verify>
  <done>Test verifies registry slugs match Page block types</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm generate:types` succeeds
- [ ] `tsc --noEmit` passes in dev/
- [ ] `pnpm test:int` passes with new sync test
- [ ] Manually verify: adding fake block to registry causes tsc error
</verification>

<success_criteria>

- BlockTypeSlug exported from registry
- Compile-time assertion links registry to Page types
- Test verifies registry/Page type alignment
- Build fails if block added to registry without updating schema (and vice versa)
</success_criteria>

<output>
After completion, create `.planning/phases/18-drift-proof-type-sync/18-01-SUMMARY.md`
</output>
