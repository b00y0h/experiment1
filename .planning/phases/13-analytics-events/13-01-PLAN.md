---
phase: 13-analytics-events
plan: 01
type: execute
---

<objective>
Create AnalyticsEvents collection to track impressions, conversions, and custom events per experiment/variant.

Purpose: Enable measurement of experiment performance by recording visitor interactions at variant and block level.
Output: AnalyticsEvents collection with test coverage, registered in payload.config.ts.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@dev/collections/Leads.ts
@dev/collections/Experiments.ts
@dev/utils/visitorId.ts
@dev/payload.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AnalyticsEvents collection with event schema</name>
  <files>dev/collections/AnalyticsEvents.ts, dev/payload.config.ts</files>
  <action>
Create AnalyticsEvents collection following Leads pattern:

Fields:
- `eventType` (select, required): 'impression' | 'conversion' | 'click' | 'custom'
- `experiment` (relationship to experiments, optional): Which experiment this event belongs to
- `variant` (relationship to page-variants, optional): Which variant was shown
- `visitorId` (text): The visitor ID from cookie
- `page` (relationship to pages, optional): Which page the event occurred on
- `blockId` (text, optional): The blockId for block-level tracking (matches nanoid(12) from blocks)
- `eventName` (text, optional): Custom event name for type='custom' (e.g., 'cta_hover', 'video_play')
- `eventData` (json, optional): Arbitrary metadata for the event
- `timestamp` (date): When the event occurred

Add beforeChange hook to auto-set timestamp on creation (same pattern as Leads' convertedAt).

Use admin.useAsTitle: 'eventType' for list display.

Register collection in payload.config.ts.

Why these fields: eventType covers standard analytics (impression/conversion) plus extensibility (click/custom). blockId enables block-level tracking using existing stable IDs. eventData JSON allows arbitrary metadata without schema changes.
  </action>
  <verify>pnpm generate:types succeeds, collection appears in generated types</verify>
  <done>AnalyticsEvents collection created with all fields, registered in config, types generated</done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests for AnalyticsEvents</name>
  <files>dev/int.spec.ts</files>
  <action>
Add test suite 'AnalyticsEvents' with these tests:

1. 'creates impression event with experiment attribution' - Create experiment, then create impression event with experiment/variant/visitorId references. Verify all fields saved correctly.

2. 'creates conversion event' - Create conversion event with page and visitorId. Verify eventType='conversion' and timestamp auto-set.

3. 'creates custom event with blockId and eventData' - Create custom event with eventName='video_play', blockId='abc123', eventData={duration: 30}. Verify JSON field stores correctly.

4. 'queries events by experiment' - Create multiple events for different experiments, query by experiment ID, verify filtering works.

Follow existing test patterns from Leads tests. Use same test setup (payload instance, dev credentials).
  </action>
  <verify>pnpm test:int passes with new tests</verify>
  <done>4 integration tests passing for AnalyticsEvents collection</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `pnpm generate:types` succeeds
- [ ] `pnpm lint` passes
- [ ] `pnpm test:int` passes (all tests including new AnalyticsEvents tests)
- [ ] AnalyticsEvents collection visible in Payload admin
</verification>

<success_criteria>

- AnalyticsEvents collection created with all specified fields
- Auto-timestamp hook working on event creation
- 4 integration tests passing
- Types generated successfully
- No lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-analytics-events/13-01-SUMMARY.md`
</output>
