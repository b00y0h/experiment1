---
phase: 08-rendering-contract
plan: 01
type: execute
---

<objective>
Create the core block resolution logic that transforms page data by replacing reusableBlockRef blocks with their actual block content.

Purpose: Enable deterministic page rendering by flattening referenced blocks into the same structure as inline blocks.
Output: `resolvePageBlocks` utility function with integration tests proving correct resolution.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@dev/collections/Pages.ts
@dev/collections/ReusableBlocks.ts
@dev/int.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create resolvePageBlocks utility function</name>
  <files>dev/utils/resolvePageBlocks.ts</files>
  <action>
Create a new utility file with a `resolvePageBlocks` function that:

1. Takes a Page document (with populated relationships at depth 1+) as input
2. Iterates through hero, content, and footer block arrays
3. For each `reusableBlockRef` block:
   - Extract the populated `block` relationship (ReusableBlock document)
   - Get the actual block content from ReusableBlock.block[0]
   - Replace the reusableBlockRef with the actual block content
   - Preserve the reusableBlockRef's settings.blockId (for analytics tracking)
   - Add a `_resolvedFrom` field with the ReusableBlock id for debugging
4. Return the transformed page with all blocks as inline content

Type signature:
```typescript
type ResolvedPage = Omit<Page, 'content'> & {
  content: Array<ContentBlock & { _resolvedFrom?: string }>
}

export function resolvePageBlocks(page: Page): ResolvedPage
```

Handle edge cases:
- reusableBlockRef with unpopulated relationship (just ID) - skip resolution, keep as-is
- reusableBlockRef pointing to ReusableBlock with empty block array - remove from output
- Null/undefined block arrays - return empty arrays

Do NOT modify the original page object - return a new transformed object.
  </action>
  <verify>pnpm generate:types && pnpm lint:fix passes, file exists with proper TypeScript types</verify>
  <done>resolvePageBlocks function created with proper typing and edge case handling</done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests for block resolution</name>
  <files>dev/int.spec.ts</files>
  <action>
Add a new describe block "Page block resolution" with tests:

1. "resolves reusableBlockRef to inline content block"
   - Create ReusableBlock with contentBlock
   - Create Page with reusableBlockRef pointing to it
   - Fetch page with depth: 2 (to populate nested block)
   - Call resolvePageBlocks()
   - Verify content[0].blockType is 'contentBlock' (not 'reusableBlockRef')
   - Verify content[0]._resolvedFrom equals ReusableBlock id

2. "resolves reusableBlockRef to inline accordion block"
   - Create ReusableBlock with accordionBlock containing items
   - Create Page referencing it
   - Resolve and verify accordionBlock with items preserved

3. "preserves inline blocks alongside resolved blocks"
   - Create Page with mix of inline contentBlock AND reusableBlockRef
   - Resolve and verify both blocks present with correct types

4. "preserves blockId from reusableBlockRef settings"
   - Create Page with reusableBlockRef
   - Resolve and verify the resolved block has the original reusableBlockRef's settings.blockId

5. "handles unpopulated reusableBlockRef gracefully"
   - Create Page, fetch with depth: 0 (relationship not populated)
   - Call resolvePageBlocks - should not crash, keep as reusableBlockRef

Import resolvePageBlocks from '../utils/resolvePageBlocks'.
Follow existing test patterns with proper TypeScript typing.
  </action>
  <verify>pnpm test:int passes all tests including new resolution tests</verify>
  <done>5 integration tests pass proving block resolution works correctly</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm generate:types` succeeds
- [ ] `pnpm lint:fix` passes
- [ ] `pnpm test:int` passes all tests
- [ ] resolvePageBlocks correctly transforms reusableBlockRef to inline blocks
- [ ] Edge cases handled (unpopulated refs, empty blocks)
</verification>

<success_criteria>

- resolvePageBlocks utility created with TypeScript types
- 5 integration tests pass
- No TypeScript errors
- Ready for 08-02 (API endpoints)
</success_criteria>

<output>
After completion, create `.planning/phases/08-rendering-contract/08-01-SUMMARY.md`
</output>
