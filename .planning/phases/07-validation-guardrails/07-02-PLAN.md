---
phase: 07-validation-guardrails
plan: 02
type: execute
---

<objective>
Add page-level validation and Lexical editor constraints to enforce conversion requirements.

Purpose: Ensure pages contain at least one conversion element and rich text is constrained appropriately.
Output: Page-level beforeValidate hook, Lexical editor configuration, and comprehensive tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-validation-guardrails/07-01-SUMMARY.md
@dev/collections/Pages.ts
@dev/collections/ReusableBlocks.ts
@dev/int.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add page-level conversion element validation</name>
  <files>dev/collections/Pages.ts</files>
  <action>
Add a beforeValidate hook to the Pages collection that enforces:
"Page must contain at least one conversion element (hero with CTA)"

Logic:
1. Check if hero array exists and has at least one heroBlock
2. Check if that heroBlock has cta.ctaText and cta.ctaLink set (both non-empty)
3. If no conversion element found, throw ValidationError with clear message

Import ValidationError from 'payload':
```ts
import { ValidationError } from 'payload'
```

Throw pattern:
```ts
throw new ValidationError({
  errors: [
    {
      message: 'Page must contain at least one conversion element (hero with CTA)',
      path: 'hero',
    },
  ],
})
```

Add this hook to the existing hooks.beforeChange array (rename to beforeValidate).
  </action>
  <verify>pnpm lint passes</verify>
  <done>Page-level validation hook added, enforces conversion element requirement</done>
</task>

<task type="auto">
  <name>Task 2: Configure Lexical editor with allowed features</name>
  <files>dev/collections/Pages.ts, dev/collections/ReusableBlocks.ts</files>
  <action>
Replace all `lexicalEditor()` calls with a configured editor that limits features:

Create a shared editor configuration (can be inline or extracted):
```ts
const restrictedLexicalEditor = lexicalEditor({
  features: ({ defaultFeatures }) => [
    ...defaultFeatures.filter(
      (feature) => !['upload', 'relationship'].includes(feature.key)
    ),
  ],
})
```

This keeps: bold, italic, underline, strikethrough, links, lists, headings
This removes: upload (embedded media), relationship (embedded documents)

Apply this restricted editor to all richText fields in:
- Pages.ts: contentBlock.body, accordionBlock.items[].content, faqBlock.items[].answer
- ReusableBlocks.ts: contentBlock.body, accordionBlock.items[].content, faqBlock.items[].answer

If the filter approach doesn't work cleanly, explicitly list the allowed features:
```ts
import {
  BoldFeature,
  ItalicFeature,
  UnderlineFeature,
  LinkFeature,
  OrderedListFeature,
  UnorderedListFeature,
  HeadingFeature,
  ParagraphFeature,
} from '@payloadcms/richtext-lexical'
```
  </action>
  <verify>pnpm lint passes, pnpm dev starts without errors</verify>
  <done>Lexical editor configured with restricted feature set</done>
</task>

<task type="auto">
  <name>Task 3: Add page-level and editor validation tests</name>
  <files>dev/int.spec.ts</files>
  <action>
Add tests to the 'Field validation' describe block:

1. Test page without conversion element - create page with hero but no CTA, expect rejection with "conversion element" message
2. Test page with valid conversion element - create page with hero that has both ctaText and ctaLink, expect success
3. Test empty hero array - create page with empty hero, expect rejection
4. Test hero with empty CTA fields - create page with hero where cta group exists but fields are empty strings, expect rejection

The Lexical configuration is harder to test directly in integration tests (would need to test via admin UI), so we verify it works by:
- Ensuring pnpm dev starts
- Ensuring existing richText tests still pass
  </action>
  <verify>pnpm test:int passes with new tests</verify>
  <done>4+ page-level validation tests passing</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm lint` passes
- [ ] `pnpm test:int` passes (all tests including new page-level validation)
- [ ] `pnpm dev` starts without errors (Lexical config valid)
- [ ] Creating page without CTA fails with "conversion element" error
- [ ] Creating page with CTA succeeds
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Pages require conversion elements
- Lexical editor has restricted feature set
- Phase 7 complete - validation + guardrails implemented
</success_criteria>

<output>
After completion, create `.planning/phases/07-validation-guardrails/07-02-SUMMARY.md`
</output>
