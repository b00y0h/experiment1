---
phase: 04-integration
type: execute
---

<objective>
Add integration tests for Pages and ReusableBlocks collections, verifying CRUD operations, block data structures, and relationship fields.

Purpose: Ensure the content model works correctly and provides confidence for future changes.
Output: Integration tests in dev/int.spec.ts covering Pages and ReusableBlocks collections.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@dev/int.spec.ts
@dev/collections/Pages.ts
@dev/collections/ReusableBlocks.ts
@dev/payload-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Pages collection integration tests</name>
  <files>dev/int.spec.ts</files>
  <action>Add a new describe block "Pages collection" with tests:
  1. "can create page with hero block" - create page with title, slug, hero array containing heroBlock with headline, verify hero[0].headline matches
  2. "can create page with content blocks" - create page with contentBlock and accordionBlock in content array, verify both blocks exist with correct blockType
  3. "enforces unique slug constraint" - create two pages with same slug, expect second to throw error
  Use typed payload.create({ collection: 'pages', data: {...} }) following existing test patterns.</action>
  <verify>pnpm test:int passes with new Pages tests</verify>
  <done>3 Pages tests pass: hero block creation, content blocks creation, unique slug validation</done>
</task>

<task type="auto">
  <name>Task 2: Add ReusableBlocks and relationship tests</name>
  <files>dev/int.spec.ts</files>
  <action>Add describe block "ReusableBlocks collection" with tests:
  1. "can create reusable accordion block" - create reusable-blocks doc with title, blockType: 'accordion', block array containing accordionBlock, verify fields
  2. "page can reference reusable block" - create a reusable block, then create a page with reusableBlockRef in content array pointing to it, verify relationship resolves (use depth: 1 on find)
  3. "can query pages with populated reusable blocks" - use payload.find with depth: 1 to get page with expanded reusableBlockRef.block data
  Follow existing test patterns with proper TypeScript typing.</action>
  <verify>pnpm test:int passes all tests including new ReusableBlocks tests</verify>
  <done>3 ReusableBlocks tests pass: creation, page reference, populated query</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `pnpm test:int` passes all tests (existing + new)
- [ ] `pnpm lint` passes without errors
- [ ] Tests cover: Pages CRUD, hero/content blocks, ReusableBlocks CRUD, relationship resolution
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- 6 new integration tests added and passing
- Phase 4 complete, milestone complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-integration/04-01-SUMMARY.md`
</output>
