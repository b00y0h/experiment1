---
phase: 06-block-settings-stable-ids
plan: 01
type: execute
---

<objective>
Add shared block settings with auto-generated stable IDs to Pages collection blocks.

Purpose: Make blocks analytics/variant-ready with durable blockIds that persist across edits.
Output: Shared blockSettings field definition, Pages.ts blocks with settings group, collection-level ID fallback hook.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./06-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-block-settings-stable-ids/06-RESEARCH.md
@dev/collections/Pages.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install nanoid and create shared blockSettings field</name>
  <files>package.json, dev/fields/blockSettings.ts</files>
  <action>
    1. Install nanoid: `pnpm add nanoid`
    2. Create dev/fields/blockSettings.ts with:
       - Import nanoid and Field type from payload
       - Export createBlockSettings function returning a group field with:
         - blockId: text field with beforeChange hook that generates nanoid(12) on create if empty
         - analyticsLabel: text field for human-readable analytics label
       - Use admin.description to explain auto-generation behavior
       - Check `operation === 'create'` AND `!value` before generating (prevents regeneration on edit)
  </action>
  <verify>File exists at dev/fields/blockSettings.ts, nanoid in package.json dependencies</verify>
  <done>blockSettings field definition exports createBlockSettings function with nanoid hook</done>
</task>

<task type="auto">
  <name>Task 2: Add settings group to all Pages.ts blocks</name>
  <files>dev/collections/Pages.ts</files>
  <action>
    1. Import createBlockSettings from '../fields/blockSettings'
    2. Add settings field (via createBlockSettings()) to each block:
       - heroBlock (in hero section)
       - contentBlock (in content section)
       - accordionBlock (in content section)
       - faqBlock (in content section)
       - statsBlock (in content section)
       - reusableBlockRef (in content section) - settings for the reference itself
       - footerBlock (in footer section)
    3. Place settings group at end of each block's fields array
    4. Run `pnpm generate:types` to update TypeScript types
  </action>
  <verify>pnpm generate:types succeeds, all 7 blocks have settings field</verify>
  <done>All Pages.ts blocks include settings group with blockId and analyticsLabel fields</done>
</task>

<task type="auto">
  <name>Task 3: Add collection-level fallback hook for ID generation</name>
  <files>dev/collections/Pages.ts</files>
  <action>
    1. Import CollectionBeforeChangeHook from payload and nanoid
    2. Create ensureBlockIds hook function that:
       - Accepts { data, operation } parameters
       - Only processes on 'create' or 'update' operations
       - Iterates through hero, content, and footer block arrays
       - For each block, ensures settings.blockId exists (generates nanoid(12) if missing)
       - Returns modified data
    3. Add hooks.beforeChange array to Pages collection config with ensureBlockIds
    4. This handles edge cases like Lexical-embedded blocks where field hooks may not fire
  </action>
  <verify>pnpm lint passes, pnpm dev starts without errors</verify>
  <done>Pages collection has beforeChange hook that ensures all blocks have blockId</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm lint` passes
- [ ] `pnpm generate:types` succeeds
- [ ] `pnpm dev` starts without errors
- [ ] Manual test: Create page with blocks, verify blockId appears in settings
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- blockSettings field reusable for Plan 2
</success_criteria>

<output>
After completion, create `.planning/phases/06-block-settings-stable-ids/06-01-SUMMARY.md`
</output>
