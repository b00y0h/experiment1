---
phase: 09-page-variants-shell
plan: 02
type: execute
---

<objective>
Create variant resolution logic and preview endpoint to render pages with variant overrides applied.

Purpose: Enable editors to preview how a page looks with a specific variant applied before activating it.
Output: resolvePageWithVariant utility, REST endpoint, Local API helper, and integration tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./09-02-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@dev/collections/PageVariants.ts
@dev/utils/resolvePageBlocks.ts
@dev/utils/getResolvedPage.ts
@dev/endpoints/resolvedPage.ts
@dev/int.spec.ts
@.planning/phases/09-page-variants-shell/09-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create resolvePageWithVariant utility</name>
  <files>dev/utils/resolvePageWithVariant.ts</files>
  <action>
Create utility function that takes a resolved page and a PageVariant, returns page with overrides applied:

```typescript
export type ResolvedPageWithVariant = ResolvedPage & {
  _variant?: {
    id: string
    name: string
  }
}

export function resolvePageWithVariant(
  page: ResolvedPage,
  variant: PageVariant
): ResolvedPageWithVariant
```

Logic:
- If variant.heroOverride has blocks, replace page.hero entirely (don't merge)
- If variant.contentOverride has blocks, replace page.content entirely
- If variant.footerOverride has blocks, replace page.footer entirely
- Run replaced sections through resolvePageBlocks logic (handle reusableBlockRef)
- Add _variant metadata with variant id and name
- Return modified page

Empty override arrays (length 0) mean "no override" - keep original section.
  </action>
  <verify>TypeScript compiles, function exported</verify>
  <done>resolvePageWithVariant function with section replacement logic and _variant metadata</done>
</task>

<task type="auto">
  <name>Task 2: Create preview endpoint and Local API helper</name>
  <files>dev/endpoints/resolvedPageWithVariant.ts, dev/utils/getResolvedPageWithVariant.ts, dev/payload.config.ts</files>
  <action>
REST endpoint at `/api/pages/:slug/variants/:variantId/preview`:
- Fetch page by slug (404 if not found)
- Fetch variant by variantId (404 if not found)
- Verify variant.page matches page.id (400 if mismatch - variant doesn't belong to this page)
- Apply resolvePageWithVariant
- Return resolved page with variant overrides

Local API helper:
```typescript
export async function getResolvedPageWithVariant(
  payload: Payload,
  slug: string,
  variantId: string
): Promise<ResolvedPageWithVariant | null>
```
- Returns null if page not found, variant not found, or variant doesn't belong to page
- Otherwise returns resolved page with variant applied

Register endpoint in payload.config.ts endpoints array.
  </action>
  <verify>Endpoint registered, TypeScript compiles</verify>
  <done>Preview endpoint and helper function for variant resolution</done>
</task>

<task type="auto">
  <name>Task 3: Add integration tests for variant preview</name>
  <files>dev/int.spec.ts</files>
  <action>
Add new describe block "Page variant preview" with tests:

1. "resolves page with hero override applied" - create page, variant with heroOverride, call getResolvedPageWithVariant, verify hero section replaced
2. "resolves page with content override applied" - variant with contentOverride, verify content section replaced
3. "preserves original sections when override is empty" - variant with empty contentOverride, verify original content kept
4. "includes _variant metadata in response" - verify _variant.id and _variant.name present
5. "REST endpoint returns 404 for unknown page" - request /api/pages/nonexistent/variants/xxx/preview
6. "REST endpoint returns 404 for unknown variant" - valid page slug, invalid variantId
7. "REST endpoint returns 400 when variant belongs to different page" - create variant for page A, request preview for page B

Use same test setup patterns as "Resolved page API" describe block.
  </action>
  <verify>pnpm test:int passes, all new tests pass</verify>
  <done>7 integration tests for variant preview functionality, all passing</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm generate:types` succeeds
- [ ] `pnpm lint` passes
- [ ] `pnpm test:int` passes including all variant preview tests
- [ ] REST endpoint responds correctly to valid and invalid requests
</verification>

<success_criteria>

- resolvePageWithVariant utility correctly applies section overrides
- REST endpoint and Local API helper provide preview access
- 7 integration tests validate all scenarios
- No TypeScript errors
- Phase 9 complete
</success_criteria>

<output>
After completion, create `.planning/phases/09-page-variants-shell/09-02-SUMMARY.md`
</output>
