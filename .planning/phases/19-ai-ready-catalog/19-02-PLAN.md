---
phase: 19-ai-ready-catalog
plan: 02
type: execute
---

<objective>
Add allowlists/guardrails for AI experiments to control which blocks AI can use.

Purpose: Different clients/campaigns may restrict which block types AI can generate. This ensures AI-generated experiments stay within approved boundaries.
Output: `allowedBlockTypes` field on Experiments collection with validation preventing use of non-allowed blocks.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./19-02-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-ai-ready-catalog/19-01-SUMMARY.md
@dev/collections/Experiments.ts
@dev/blocks/registry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add allowedBlockTypes field to Experiments</name>
  <files>dev/collections/Experiments.ts, dev/blocks/registry.ts</files>
  <action>
Add multi-select field `allowedBlockTypes` to Experiments collection:
1. Import `getBlockSlugs` from `../blocks/registry.js`
2. Add field after `status`:
```ts
{
  name: 'allowedBlockTypes',
  type: 'select',
  hasMany: true,
  options: getBlockSlugs().map(slug => ({ label: blockRegistry[slug].label, value: slug })),
  admin: {
    description: 'Block types AI can use for this experiment (empty = all allowed)',
  },
}
```

Import blockRegistry as well for accessing labels.

Semantics: Empty array = no restriction (all blocks allowed). Non-empty = only these blocks allowed.
  </action>
  <verify>
pnpm generate:types succeeds, Experiments type includes `allowedBlockTypes?: BlockTypeSlug[]`
  </verify>
  <done>
- Field added to Experiments collection
- Types generated correctly
- Admin UI shows multi-select with all 7 block types
  </done>
</task>

<task type="auto">
  <name>Task 2: Create guardrail validation utility</name>
  <files>dev/utils/experimentGuardrails.ts</files>
  <action>
Create `dev/utils/experimentGuardrails.ts` with:

```ts
import type { BlockTypeSlug } from '../blocks/registry.js'

/**
 * Check if a block type is allowed for an experiment.
 * Empty allowedBlockTypes = all blocks allowed.
 */
export function isBlockAllowed(
  blockType: BlockTypeSlug,
  allowedBlockTypes: BlockTypeSlug[] | null | undefined
): boolean {
  // Empty or null = no restrictions
  if (!allowedBlockTypes || allowedBlockTypes.length === 0) {
    return true
  }
  return allowedBlockTypes.includes(blockType)
}

/**
 * Get allowed blocks for an experiment as catalog subset.
 * Returns all blocks if no restrictions.
 */
export function getAllowedBlocks(
  allowedBlockTypes: BlockTypeSlug[] | null | undefined
): BlockTypeSlug[] {
  if (!allowedBlockTypes || allowedBlockTypes.length === 0) {
    return getBlockSlugs()
  }
  return allowedBlockTypes
}
```

Import `getBlockSlugs` from `../blocks/registry.js`.
  </action>
  <verify>
pnpm lint passes, types check correctly
  </verify>
  <done>
- `isBlockAllowed()` utility created
- `getAllowedBlocks()` utility created
- Handles null/undefined/empty as "all allowed"
  </done>
</task>

<task type="auto">
  <name>Task 3: Add integration tests for guardrails</name>
  <files>dev/int.spec.ts</files>
  <action>
Add test suite "Experiment Guardrails" with tests:

1. "experiment with no allowedBlockTypes allows all blocks" - Create experiment without allowedBlockTypes, verify isBlockAllowed returns true for all block types

2. "experiment with allowedBlockTypes restricts to specified" - Create experiment with allowedBlockTypes: ['heroBlock', 'contentBlock'], verify isBlockAllowed returns true for heroBlock, false for faqBlock

3. "getAllowedBlocks returns subset when restricted" - Verify getAllowedBlocks returns only specified blocks

4. "getAllowedBlocks returns all when unrestricted" - Verify getAllowedBlocks returns all 7 blocks when allowedBlockTypes is empty/null

Import utilities from '../utils/experimentGuardrails.js'.
  </action>
  <verify>pnpm test:int passes with all guardrails tests</verify>
  <done>
- 4 new integration tests for guardrails
- All tests pass
- Coverage for allowed/disallowed logic
- Phase 19 complete
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm generate:types` succeeds
- [ ] `pnpm test:int` passes all tests including guardrails tests
- [ ] `pnpm lint` passes
- [ ] Experiments collection has allowedBlockTypes field in admin UI
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Experiments can specify which block types AI is allowed to use
- Guardrail utilities available for AI integration code
- Phase 19: AI-Ready Catalog complete
</success_criteria>

<output>
After completion, create `.planning/phases/19-ai-ready-catalog/19-02-SUMMARY.md`
</output>
