---
phase: 10-experiment-collection
plan: 01
type: execute
---

<objective>
Create Experiments collection that links page variants with traffic allocation percentages and activation rules for A/B testing.

Purpose: Enable editors to configure A/B experiments by selecting page variants, defining traffic splits, and setting activation rules (start/end dates, status).
Output: Experiments collection with validation, plus integration tests proving CRUD operations and traffic allocation constraints.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./10-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@dev/collections/PageVariants.ts
@dev/collections/Pages.ts
@dev/payload.config.ts
@dev/int.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Experiments collection</name>
  <files>dev/collections/Experiments.ts, dev/payload.config.ts</files>
  <action>
Create Experiments collection with fields:
- name (text, required) - experiment identifier
- page (relationship to pages, required) - the base page being tested
- variants (array, required, minRows: 2) - array of variant configurations:
  - variant (relationship to page-variants, required)
  - trafficPercent (number, required, min: 0, max: 100) - percentage of traffic
- status (select: draft/running/paused/completed, default: draft)
- startDate (date) - when experiment activates (optional, null = manual activation)
- endDate (date) - when experiment ends (optional, null = no auto-end)

Add beforeChange hook to validate:
1. All variants must belong to the same page (variant.page === experiment.page)
2. Traffic percentages must sum to exactly 100 when status is 'running'
3. At least 2 variants required for a valid experiment

Follow existing collection patterns from PageVariants.ts (similar structure).
Register in payload.config.ts collections array.

Do NOT add any UI components or endpoints - this phase is collection-only.
  </action>
  <verify>pnpm generate:types succeeds and creates Experiment type in payload-types.ts</verify>
  <done>Experiments collection exists with all fields, registered in payload config, types generated</done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests for Experiments collection</name>
  <files>dev/int.spec.ts</files>
  <action>
Add new describe block 'Experiments collection' with tests:
1. Can create experiment with two variants (success case)
2. Traffic percentages sum validation - reject when not 100% and status is 'running'
3. Traffic percentages allow non-100 when status is 'draft'
4. Variant page mismatch validation - reject variant from different page
5. Minimum 2 variants required - reject single variant

Tests should:
- Create a test page with hero/CTA first
- Create two page variants for that page
- Test various experiment configurations

Follow existing test patterns from int.spec.ts (use payload.create, expect assertions).
  </action>
  <verify>pnpm test:int passes all tests including new Experiments tests</verify>
  <done>5 new integration tests pass, covering CRUD and validation scenarios</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `pnpm generate:types` succeeds without errors
- [ ] `pnpm lint` passes
- [ ] `pnpm test:int` passes all tests (including 5 new Experiments tests)
- [ ] Experiment type appears in dev/payload-types.ts
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Experiments collection properly validates traffic allocation
- Experiments collection properly validates variant page consistency
</success_criteria>

<output>
After completion, create `.planning/phases/10-experiment-collection/10-01-SUMMARY.md`:

# Phase 10-01: Experiments Collection Summary

**[Substantive one-liner]**

## Performance
- **Duration:** X min
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `dev/collections/Experiments.ts` - Experiments collection with validation hooks
- `dev/payload.config.ts` - Registered Experiments collection
- `dev/int.spec.ts` - Added 5 integration tests

## Decisions Made
[Any decisions]

## Issues Encountered
[Any issues]

## Next Phase Readiness
[Status for Phase 11]
</output>
