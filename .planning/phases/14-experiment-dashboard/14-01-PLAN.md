---
phase: 14-experiment-dashboard
type: execute
---

<objective>
Create admin dashboard components for viewing experiment results and managing experiment lifecycle.

Purpose: Enable editors to monitor A/B test performance and control experiment states without leaving the admin panel.
Output: ExperimentStats RSC component showing per-variant metrics, integration with admin dashboard.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@dev/collections/Experiments.ts
@dev/collections/AnalyticsEvents.ts
@dev/collections/Leads.ts
@dev/payload.config.ts
@src/components/BeforeDashboardServer.tsx
@src/exports/rsc.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExperimentStats dashboard component</name>
  <files>dev/components/ExperimentStats.tsx, dev/components/ExperimentStats.module.css</files>
  <action>
Create a React Server Component that displays experiment statistics in the admin beforeDashboard area.

The component should:
1. Query experiments collection with status = 'running' or 'paused' (active experiments)
2. For each experiment, aggregate analytics-events to calculate:
   - Total impressions per variant (eventType = 'impression')
   - Total conversions per variant (eventType = 'conversion')
   - Conversion rate = (conversions / impressions) * 100
3. Display a summary card per experiment showing:
   - Experiment name and status
   - A table with variants and their metrics (impressions, conversions, rate)
   - Visual indicator for which variant is "winning" (highest conversion rate)

Use the same ServerComponentProps pattern from BeforeDashboardServer.tsx.
Query via payload.find() with depth:1 to get populated variant names.

CSS module should style the dashboard cards to fit Payload's admin aesthetic (minimal, clean).
Avoid complex styling - just basic flexbox layout and table styling.
  </action>
  <verify>Component file exists and exports ExperimentStats, CSS module exists</verify>
  <done>ExperimentStats.tsx created with stats aggregation logic, renders experiment cards with variant metrics</done>
</task>

<task type="auto">
  <name>Task 2: Register ExperimentStats in payload.config.ts</name>
  <files>dev/payload.config.ts</files>
  <action>
Add the ExperimentStats component to the admin.components.beforeDashboard array.

Import pattern: Component is a dev app component (not plugin), so use direct import path.
Since this is dev app specific (not plugin), add directly to the config's admin.components.beforeDashboard.

Add the component configuration in buildConfig's admin section:
```ts
admin: {
  components: {
    beforeDashboard: ['./components/ExperimentStats.js#ExperimentStats'],
  },
  // ... existing importMap
}
```

Note: The .js extension is required because Payload uses the compiled path.
  </action>
  <verify>pnpm dev starts without errors, dashboard shows ExperimentStats component</verify>
  <done>ExperimentStats registered in beforeDashboard, visible on admin dashboard</done>
</task>

<task type="auto">
  <name>Task 3: Add integration test for experiment stats calculation</name>
  <files>dev/int.spec.ts</files>
  <action>
Add integration tests for the experiment stats calculation logic.

Test: "ExperimentStats calculates correct metrics"
1. Create a page, two page-variants, and an experiment (status: running)
2. Create analytics-events:
   - 100 impressions for variant A
   - 80 impressions for variant B
   - 10 conversions for variant A (10% rate)
   - 12 conversions for variant B (15% rate)
3. Query analytics-events grouped by experiment and variant
4. Assert: Correct counts per variant, correct conversion rates

This tests the query/aggregation logic that the component uses.
Note: Test the query pattern, not the React component itself (component testing is out of scope for integration tests).

Add helper function `calculateExperimentStats` in a new file dev/utils/experimentStats.ts that the component and tests both use - this makes the logic testable.
  </action>
  <verify>pnpm test:int passes all new tests</verify>
  <done>calculateExperimentStats utility with tests, ExperimentStats component uses this utility</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `pnpm lint` passes
- [ ] `pnpm test:int` passes all tests including new ExperimentStats tests
- [ ] `pnpm dev` starts without errors
- [ ] ExperimentStats component visible on admin dashboard (when experiments exist)
</verification>

<success_criteria>

- ExperimentStats component displays experiment name, status, and per-variant metrics
- Conversion rate calculated correctly (conversions/impressions * 100)
- Component integrated into admin dashboard via beforeDashboard
- calculateExperimentStats utility testable and tested
- All tests pass, no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/14-experiment-dashboard/14-01-SUMMARY.md`:

# Phase 14-01: Experiment Dashboard Summary

**[Substantive one-liner about what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

[Phase complete, v3.0 milestone complete, ready for plugin extraction]
</output>
