# Milestone v4.0: Block ↔ Component Sync + AI Catalog

**Status:** ✅ SHIPPED 2025-12-31
**Phases:** 15-19
**Total Plans:** 8

## Overview

Frontend renderer mapping that stays in lockstep with Payload block definitions, plus an auto-updating AI catalog of allowed blocks for experiments.

## Phases

### Phase 15: Repo Normalization

**Goal**: Make the Payload CMS app the "real" project (stop treating /dev like a temporary shell)
**Depends on**: v3.0 complete
**Plans**: 1 plan

Plans:
- [x] 15-01: Promote /dev to primary app boundary

**Details:**
- Updated CLAUDE.md to describe /dev as primary Payload CMS app
- Updated package.json description to reflect actual project purpose
- Added src/README.md explaining template status

### Phase 16: Block Registry

**Goal**: Create a single, canonical "Block Registry" that describes all blocks and can be consumed by the front end + AI
**Depends on**: Phase 15
**Plans**: 2 plans

Plans:
- [x] 16-01: Create canonical Block Registry in-code (Payload-first)
- [x] 16-02: Generate machine-readable registry artifact

**Details:**
- Created dev/blocks/registry.ts with factory functions for all 7 block types
- Updated Pages.ts and ReusableBlocks.ts to import from registry
- Created schema generation utility (dev/blocks/schema.ts)
- Added pnpm generate:registry script
- Generated dev/block-registry.json artifact

### Phase 17: Frontend Renderer Mapping

**Goal**: Map blockType -> component with safe fallbacks and hard checks
**Depends on**: Phase 16
**Plans**: 1 plan

Plans:
- [x] 17-01: Implement renderBlock() dispatch + unknown-block handling

**Details:**
- Created dev/render/renderBlock.tsx with dispatch function
- Added placeholder components for all 7 block types
- Implemented UnknownBlock fallback component
- Added exhaustive type checking with never pattern
- Added integration tests for dispatch and unknown block handling

### Phase 18: Drift-Proof Type Sync

**Goal**: Make "CMS changed but FE didn't" fail at build/CI time instead of breaking in production
**Depends on**: Phase 17
**Plans**: 2 plans

Plans:
- [x] 18-01: Enforce compile-time contract between registry + components
- [x] 18-02: Add CI gates + integration tests for registry/rendering coverage

**Details:**
- Exported BlockTypeSlug union from registry
- Added compile-time assertion linking registry to Page types
- Created check:registry script to detect code/JSON drift
- Added check:sync script combining all drift-proof validations
- Added 100% rendering coverage test from registry.json

### Phase 19: AI-Ready Catalog

**Goal**: AI always knows what blocks exist right now and what it's allowed to use per client/campaign
**Depends on**: Phase 18
**Plans**: 2 plans

Plans:
- [x] 19-01: Publish "available blocks" catalog endpoint for AI + tooling
- [x] 19-02: Add allowlists/guardrails for AI experiments

**Details:**
- Created /api/blocks/catalog REST endpoint
- Endpoint returns RegistrySchema JSON with all 7 block types
- Added cache headers for performance
- Added allowedBlockTypes field to Experiments collection
- Created experimentGuardrails utility (isBlockAllowed, getAllowedBlocks)
- Added integration tests for catalog and guardrails

---

## Milestone Summary

**Key Decisions:**

- Block factory functions: Good — allows fresh createBlockSettings() per-use
- Registry-derived types: Good — BlockTypeSlug from blockRegistry keys is single source of truth
- Exhaustive switch for rendering: Good — TypeScript catches missing cases at compile time
- JSON registry artifact: Good — machine-readable for AI/tooling automation
- Empty allowedBlockTypes = all: Good — intuitive default simplifies unrestricted experiments

**Issues Resolved:**

- Block duplication between Pages.ts and ReusableBlocks.ts — consolidated in registry
- No compile-time check for missing renderers — now fails build if registry/render diverge
- AI has no way to discover available blocks — now has REST endpoint

**Issues Deferred:**

- Plugin extraction from dev app (future milestone)

**Technical Debt Incurred:**

- Placeholder components in renderBlock.tsx (consumers provide real components)

---

_For current project status, see .planning/ROADMAP.md_
