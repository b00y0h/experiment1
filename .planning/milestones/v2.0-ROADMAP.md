# Milestone v2.0: Page Assembly + Variant Ready

**Status:** SHIPPED 2025-12-30
**Phases:** 5-9
**Total Plans:** 9

## Overview

Enable fully-assembled landing pages with variant support for A/B testing and analytics integration. Added block library expansion, stable blockIds for tracking, validation guardrails, rendering contract with API endpoints, and page variants shell.

## Phases

### Phase 5: Block Library Expansion

**Goal**: Add the core landing-page blocks needed to build real paid-search pages end to end
**Depends on**: Phase 4 (v1.0 complete)
**Plans**: 1 plan

Plans:
- [x] 05-01: FAQ and Stats blocks with integration tests

**Details:**
- Added FAQ block type with question/answer pairs to both Pages and ReusableBlocks
- Added Stats block type with value/label/icon structure to both Pages and ReusableBlocks
- 4 new integration tests pass (2 Pages tests + 2 ReusableBlocks tests)

---

### Phase 6: Block Settings + Stable IDs

**Goal**: Make every block variant/analytics-ready with consistent settings and durable blockIds
**Depends on**: Phase 5
**Plans**: 2 plans

Plans:
- [x] 06-01: Shared blockSettings field with nanoid(12) blockIds for Pages blocks
- [x] 06-02: Add blockSettings to ReusableBlocks collection

**Details:**
- Created reusable `createBlockSettings()` field factory with blockId and analyticsLabel
- Added settings group to all 7 Pages.ts blocks (hero, content, accordion, reusableBlockRef, faq, stats, footer)
- Implemented collection-level `ensureBlockIds` hook as fallback for edge cases
- Added blockSettings with nanoid(12) blockIds to all 5 ReusableBlocks blocks
- 4 integration tests proving ID auto-generation, stability, and preservation

---

### Phase 7: Validation + Guardrails

**Goal**: Prevent invalid pages/blocks and enforce compliance/conversion requirements at the model level
**Depends on**: Phase 6
**Plans**: 2 plans

Plans:
- [x] 07-01: Field-level constraints (headline maxLength, CTA validation, array limits)
- [x] 07-02: Page-level validation (conversion element required) + Lexical editor config

**Details:**
- Created shared validators module with maxLengthValidator, urlValidator, and ctaValidator
- Applied field constraints to heroBlock (headline maxLength, CTA validation)
- Added array limits to accordionBlock (20), faqBlock (30), statsBlock (12)
- Added page-level `validateConversionElement` hook requiring at least one hero with complete CTA
- Configured restricted Lexical editor removing upload and relationship features
- 15 integration tests for field and page-level validation

---

### Phase 8: Rendering Contract

**Goal**: Expose a deterministic, fully-resolved page JSON payload that Next.js can render with a single request
**Depends on**: Phase 7
**Plans**: 2 plans

Plans:
- [x] 08-01: Core resolution logic (resolvePageBlocks utility + tests)
- [x] 08-02: API endpoints (REST endpoint + Local API helper + tests)

**Details:**
- Created resolvePageBlocks utility that flattens reusableBlockRef blocks into inline content
- Preserves blockId from reusableBlockRef settings for analytics tracking
- REST endpoint at `/api/pages/:slug/resolved`
- getResolvedPage Local API helper for server components
- 10 integration tests for resolution logic and API endpoints

---

### Phase 9: Page Variants Shell

**Goal**: Introduce variants and experiments as first-class objects so you can preview overrides and prepare for A/B testing
**Depends on**: Phase 8
**Plans**: 2 plans

Plans:
- [x] 09-01: PageVariants collection with block override fields
- [x] 09-02: Variant preview endpoint and resolution logic

**Details:**
- Created PageVariants collection with name, page reference, status, and three override block arrays
- All blocks in override arrays get auto-generated blockIds via collection-level hook
- Created resolvePageWithVariant utility applying variant overrides with section replacement logic
- REST endpoint at `/api/pages/:slug/variants/:variantId/preview`
- getResolvedPageWithVariant Local API helper for server components
- 12 integration tests for PageVariants CRUD and variant preview functionality

---

## Milestone Summary

**Key Decisions:**

- nanoid(12) for blockIds: Compact, URL-safe, collision-resistant stable IDs (Good)
- Field-level hook for ID generation with collection-level fallback (Good)
- URL validator accepts relative paths starting with `/` in addition to http/https (Good)
- CTA validator uses group-level validate rather than beforeValidate hook (Good)
- Lexical editor restriction uses filter approach for flexibility (Good)
- Section replacement uses "replace entirely" strategy for variants (Good)
- Empty override arrays mean "no override" - original section preserved (Good)

**Issues Resolved:**

- Established rendering contract for deterministic page JSON
- Created variant preview system for A/B testing preparation
- Unified block ID generation across all collections

**Issues Deferred:**

- Plugin extraction from dev app (to future milestone)
- Variant activation logic (switching between draft/active/archived states)
- A/B testing infrastructure and traffic splitting

**Technical Debt Incurred:**

- Block type definitions duplicated in PageVariants.ts (could extract shared definitions)
- MongoDB memory server transient connection errors during tests (known flaky behavior)

---

_For current project status, see .planning/ROADMAP.md_
